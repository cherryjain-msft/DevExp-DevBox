# yaml-language-server: $schema=https://aka.ms/configuration-dsc-schema/0.2
properties:
  configurationVersion: "0.2.0"
  # This DSC configuration enables Windows virtualization features.
  # 
  # Purpose:
  # Sets up Windows Subsystem for Linux (WSL) to support Linux workloads
  # on Windows development environments.
  #
  # Components:
  # - WSL: Windows Subsystem for Linux with Ubuntu distribution
  resources:
    # Install Windows Subsystem for Linux (WSL)
    # Enables the WSL feature and installs Ubuntu distribution for Linux development
    - resource: PSDscResources/Script
      id: Microsoft-Windows-Subsystem-Linux
      directives:
        description: Enable Windows Features and Install Ubuntu for WSL
        securityContext: elevated
      settings:
        SetScript: |
          Write-Verbose "Installing Windows Subsystem for Linux (WSL)" -Verbose
          wsl --install --no-launch
          wsl --install -d Ubuntu --no-launch
          $newUser = $env:USERNAME.ToLower()
          $password = "SecureP@ssw0rd"
          $escapedPassword = $password -replace '(["\\$`])', '\\$1'  # Escape for bash

          # Call WSL with the single-line bash command
          wsl.exe -d Ubuntu -u root -- bash -c "sudo adduser --quiet --disabled-password --gecos '' $newUser"
          wsl.exe -d Ubuntu -u root -- bash -c "echo '${newUser}:${escapedPassword}' | sudo chpasswd"
          wsl.exe -d Ubuntu -u root -- bash -c "sudo usermod -aG sudo $newUser"
          wsl.exe -d Ubuntu -u root -- bash -c "echo '$newUser ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/$newUser"
        GetScript: return $false
        TestScript: return $false

    - resource: PSDscResources/Script
      id: Ubuntu
      directives:
        description: Enable Windows Features and Install Ubuntu for WSL
        securityContext: elevated
      settings:
        SetScript: |
          sudo apt-get update
          sudo apt-get upgrade -y
        GetScript: return $false
        TestScript: return $false
